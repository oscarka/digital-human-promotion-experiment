# åç«¯ Dockerfile
# ä½¿ç”¨ node:20-slim ä»£æ›¿ alpineï¼ˆé¿å… npm é—®é¢˜ï¼‰
FROM node:20-slim

WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY server/package*.json ./

# å®‰è£…ä¾èµ–ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶å…¨æ–°å®‰è£…ï¼Œç¦ç”¨ä»£ç†ä½¿ç”¨å›½å†…é•œåƒï¼‰
RUN echo "ğŸ” å¼€å§‹å®‰è£…ä¾èµ–..." && \
  echo "ğŸ“‹ æ£€æŸ¥æ–‡ä»¶ï¼š" && \
  ls -la package*.json && \
  echo "" && \
  echo "ğŸ§¹ æ¸…é™¤ npm ç¼“å­˜..." && \
  npm cache clean --force && \
  rm -f package-lock.json && \
  echo "âš¡ï¸ è®¾ç½® npm é•œåƒæºå¹¶ç¦ç”¨ä»£ç†..." && \
  npm config set registry https://registry.npmmirror.com && \
  npm config set proxy null && \
  npm config set https-proxy null && \
  npm config delete proxy && \
  npm config delete https-proxy && \
  unset HTTP_PROXY HTTPS_PROXY http_proxy https_proxy && \
  echo "ğŸ“¦ å…¨æ–°å®‰è£…ä¾èµ–..." && \
  npm install && \
  echo "" && \
  echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼Œæ£€æŸ¥ node_modulesï¼š" && \
  ls -la node_modules/ 2>&1 | head -10 && \
  echo "" && \
  echo "ğŸ” æ£€æŸ¥ express ç›®å½•ç»“æ„ï¼š" && \
  ls -la node_modules/express/ 2>&1 | head -10 || echo "âŒ express æœªæ‰¾åˆ°" && \
  echo "" && \
  echo "ğŸ” æ£€æŸ¥ express package.jsonï¼š" && \
  cat node_modules/express/package.json 2>&1 | head -20 || echo "âŒ express package.json æœªæ‰¾åˆ°" && \
  echo "" && \
  echo "ğŸ“Š node_modules å¤§å°ï¼š" && \
  du -sh node_modules 2>&1

# å¤åˆ¶æºä»£ç 
COPY server/ ./

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p data

# æ·»åŠ å¯åŠ¨å‰æ£€æŸ¥
RUN echo "ğŸ” æœ€ç»ˆæ£€æŸ¥ï¼š" && \
  echo "ğŸ“‚ å·¥ä½œç›®å½•å†…å®¹ï¼š" && \
  ls -la && \
  echo "" && \
  echo "ğŸ“¦ node_modules å­˜åœ¨: $([ -d node_modules ] && echo 'æ˜¯' || echo 'å¦')" && \
  echo "ğŸ“„ index.js å­˜åœ¨: $([ -f index.js ] && echo 'æ˜¯' || echo 'å¦')"

EXPOSE 8080

# åˆ›å»ºå¯åŠ¨è„šæœ¬æ¥æ•è·è¯¦ç»†çš„å¯åŠ¨ä¿¡æ¯
RUN echo '#!/bin/sh' > /start.sh && \
  echo 'echo "ğŸš€ å¯åŠ¨å®¹å™¨..."' >> /start.sh && \
  echo 'echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"' >> /start.sh && \
  echo 'echo "ğŸ“‚ æ–‡ä»¶åˆ—è¡¨:"' >> /start.sh && \
  echo 'ls -la' >> /start.sh && \
  echo 'echo ""' >> /start.sh && \
  echo 'echo "ğŸ” ç¯å¢ƒå˜é‡:"' >> /start.sh && \
  echo 'echo "  PORT=${PORT}"' >> /start.sh && \
  echo 'echo "  NODE_ENV=${NODE_ENV}"' >> /start.sh && \
  echo 'echo "  GEMINI_API_KEY: $([ -n \"$GEMINI_API_KEY\" ] && echo \"å·²è®¾ç½®\" || echo \"æœªè®¾ç½®\")"' >> /start.sh && \
  echo 'echo ""' >> /start.sh && \
  echo 'echo "ğŸ¯ å¯åŠ¨ Node.js åº”ç”¨..."' >> /start.sh && \
  echo 'exec node index.js' >> /start.sh && \
  chmod +x /start.sh

# å¯åŠ¨æœåŠ¡
CMD ["/start.sh"]

