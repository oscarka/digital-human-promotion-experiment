version: '3.8'

services:
  # 前端服务
  frontend:
    image: oscarzhangzzzz/digital-human-frontend:latest
    ports:
      - "3005:80"
    env_file:
      - .env
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - app-network

  # 后端服务
  backend:
    image: oscarzhangzzzz/digital-human-backend:latest
    ports:
      - "3002:3002"
    environment:
      - TELEPHONE_SERVER_PORT=3002
      - NODE_ENV=production
    env_file:
      - .env
    volumes:
      # 只保留数据持久化，不挂载代码和配置（使用镜像内置的配置，避免覆盖）
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - app-network

  # 代理服务 (必须配合 Allow LAN 使用)
  proxy:
    image: oscarzhangzzzz/digital-human-proxy:latest
    ports:
      - "3001:3001"
    environment:
      # Docker 容器内连接宿主机的 7897 端口
      - HTTPS_PROXY=http://host.docker.internal:7897
      - HTTP_PROXY=http://host.docker.internal:7897
      - PROXY_PORT=3001
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
