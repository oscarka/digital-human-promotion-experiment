# å‰ç«¯ Dockerfile
# ä½¿ç”¨ node:20-slim ä»£æ›¿ alpineï¼ˆé¿å… npm åœ¨ alpine ä¸Šçš„é—®é¢˜ï¼‰
FROM node:20-slim AS builder

WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./
COPY vite.config.ts tsconfig.json ./

# å®‰è£…ä¾èµ–ï¼ˆç¡®ä¿å®‰è£… devDependenciesï¼Œæ„å»ºéœ€è¦ viteï¼‰
# æ˜ç¡®è®¾ç½® NODE_ENV=development ç¡®ä¿ devDependencies è¢«å®‰è£…
ENV NODE_ENV=development
# ä½¿ç”¨ npm ci ä»£æ›¿ npm installï¼ˆæ›´å¯é ï¼ŒåŸºäº package-lock.jsonï¼‰
RUN echo "ğŸ” å¼€å§‹å®‰è£…ä¾èµ–..." && \
    echo "ğŸ“‹ æ£€æŸ¥ package.jsonï¼š" && \
    cat package.json && \
    echo "" && \
    echo "ğŸŒ æ£€æŸ¥ NODE_ENVï¼š$NODE_ENV" && \
    echo "" && \
    echo "ğŸ“¦ æ‰§è¡Œ npm ciï¼ˆå¦‚æœ package-lock.json å­˜åœ¨ï¼‰..." && \
    if [ -f "package-lock.json" ]; then \
      npm ci --legacy-peer-deps || (echo "âš ï¸  npm ci å¤±è´¥ï¼Œå°è¯• npm install..." && npm install --legacy-peer-deps) || exit 1; \
    else \
      echo "âš ï¸  package-lock.json ä¸å­˜åœ¨ï¼Œä½¿ç”¨ npm install..." && \
      npm install --legacy-peer-deps || exit 1; \
    fi && \
    echo "" && \
    echo "âœ… å®‰è£…å®Œæˆï¼Œæ£€æŸ¥ç»“æœï¼š" && \
    echo "ğŸ“‚ node_modules å­˜åœ¨: $([ -d node_modules ] && echo 'æ˜¯' || echo 'å¦')" && \
    echo "ğŸ“¦ node_modules/.bin å­˜åœ¨: $([ -d node_modules/.bin ] && echo 'æ˜¯' || echo 'å¦')" && \
    if [ ! -d "node_modules/.bin" ]; then \
      echo "âŒ .bin ç›®å½•ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åˆ›å»ºå¹¶å®‰è£… vite..." && \
      npm install vite@^6.2.0 --save-dev --legacy-peer-deps 2>&1; \
    fi && \
    echo "" && \
    echo "ğŸ” æœ€ç»ˆæ£€æŸ¥ï¼š" && \
    ls -la node_modules/.bin/ 2>&1 | head -10 || echo "âŒ .bin ä»ç„¶ä¸å­˜åœ¨" && \
    echo "" && \
    echo "ğŸ“Š node_modules å¤§å°ï¼š" && \
    du -sh node_modules 2>&1

# å¤åˆ¶æºä»£ç ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
COPY App.tsx index.html index.tsx records.html records.tsx ./
COPY components ./components
COPY services ./services
COPY constants.ts types.ts ./

# æ„å»ºå‰ç«¯ï¼ˆä½¿ç”¨ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼‰
# å¦‚æœç¯å¢ƒå˜é‡ä¸ºç©ºï¼Œæ„å»ºæ—¶ä¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œè¿è¡Œæ—¶è‡ªåŠ¨è¯†åˆ«åŸŸå
ARG VITE_API_BASE_URL
ARG VITE_WS_BASE_URL
ARG VITE_DOMAIN
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_WS_BASE_URL=$VITE_WS_BASE_URL
ENV VITE_DOMAIN=$VITE_DOMAIN

# æ„å»ºå‰ç«¯ï¼ˆä½¿ç”¨ npx vite buildï¼Œå³ä½¿ .bin ä¸å­˜åœ¨ä¹Ÿèƒ½å·¥ä½œï¼‰
RUN echo "ğŸ”¨ å¼€å§‹æ„å»º..." && \
    echo "ğŸ“‚ å½“å‰ç›®å½•ï¼š" && pwd && \
    echo "ğŸ“¦ æ£€æŸ¥ node_modulesï¼š" && \
    ls -la node_modules/ 2>&1 | head -10 || echo "âš ï¸  node_modules ä¸å­˜åœ¨" && \
    echo "ğŸ” æŸ¥æ‰¾ viteï¼š" && \
    find node_modules -name "vite" -type f 2>&1 | head -5 || echo "âš ï¸  vite æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨ npx" && \
    echo "ğŸš€ ä½¿ç”¨ npx vite buildï¼ˆæ›´å¯é ï¼‰ï¼š" && \
    npx vite build || (echo "âŒ npx vite build å¤±è´¥ï¼Œå°è¯• npm run build..." && npm run build)

# ç”Ÿäº§ç¯å¢ƒé•œåƒï¼ˆä½¿ç”¨æœ¬åœ°å·²æ‹‰å–çš„é•œåƒ IDï¼Œé¿å…ç½‘ç»œéªŒè¯ï¼‰
FROM nginx@sha256:c881927c4077710ac4b1da63b83aa163937fb47457950c267d92f7e4dedf4aec

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ° nginx
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
